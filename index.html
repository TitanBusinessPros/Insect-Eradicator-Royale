<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Insect Eradicator Royale</title>
    
    <!-- Favicon - Replace with your GitHub raw PNG link -->
    <link rel="icon" type="image/png" href="https://github.com/TitanBusinessPros/BugDefense-/raw/main/PestVanIcon.png">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-image: url('https://github.com/TitanBusinessPros/BugDefense-/raw/main/DarkGrass.jpeg');
            background-size: 35%;
            color: white;
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            position: relative;
        }
        
        .audio-controls {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .audio-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.3s;
        }
        
        .audio-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
        
        .game-stats {
            display: flex;
            justify-content: space-between;
            background: rgba(0, 0, 0, 0.4);
            padding: 10px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .game-area {
            display: flex;
            gap: 20px;
        }
        
        .game-board {
            flex: 3;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 20px;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }
        
        .controls {
            flex: 1;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
        }
        
        .tower-selection {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .tower-option {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        
        .tower-option:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .tower-option.selected {
            background: rgba(255, 215, 0, 0.3);
            border: 2px solid gold;
        }
        
        .tower-icon {
            width: 60px;
            height: 60px;
            margin: 0 auto 5px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }
        
        button {
            background: linear-gradient(to bottom, #ba03fc, #6703fc);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            font-size: 1.1rem;
        }
        
        button:hover {
            background: linear-gradient(to bottom, #6703fc, #430585);
        }
        
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        #grid-container {
            position: relative;
            width: 840px;
            height: 840px;
            background: rgba(0, 0, 0, 0.2);
        }
        
        .grid-cell {
            position: absolute;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.2s;
            touch-action: manipulation;
            cursor: pointer;
        }
        
        .grid-cell.path {
            background-image: url('https://github.com/TitanBusinessPros/BugDefense-/raw/main/LightDirt.jpeg');
            background-size: 150%;
            background-position: center;
            background-repeat: no-repeat;
        }
        
        .grid-cell.grass {
            background-image: url('https://github.com/TitanBusinessPros/BugDefense-/raw/main/DarkGrass.jpeg');
            background-size: 190%;
            background-position: center;
            background-repeat: no-repeat;
        }
        
        .grid-cell.valid {
            background: rgba(144, 238, 144, 0.6);
            cursor: pointer;
        }
        
        .grid-cell.invalid {
            background: rgba(255, 99, 71, 0.4);
            cursor: not-allowed;
        }
        
        .tower {
            position: absolute;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            transform-origin: center;
            pointer-events: none;
        }
        
        .tower.range-display {
            border: 2px dashed rgba(255, 255, 255, 0.5);
            background: rgba(255, 255, 255, 0.1);
            z-index: 5;
            pointer-events: none;
        }
        
        .enemy {
            position: absolute;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 15;
            transition: left 0.1s linear, top 0.1s linear;
            pointer-events: none;
        }
        
        .enemy.slowed {
            animation: pulse-slow 1s infinite;
        }
        
        .projectile {
            position: absolute;
            border-radius: 50%;
            z-index: 12;
            pointer-events: none;
            transition: all 0.1s linear;
        }
        
        .projectile.bullet {
            width: 10px;
            height: 10px;
            background: #8A2BE2;
        }
        
        .projectile.strong {
            width: 4px;
            height: 18px;
            background: #ffbf00;
            border-radius: 2px;
        }
        
        .projectile.bomb {
            width: 15px;
            height: 15px;
            background: #9ACD32;
            animation: bomb-spin 0.5s linear infinite;
        }
        
        .projectile.glue {
            width: 10px;
            height: 10px;
            background: #00BCD4;
            border-radius: 2px;
            animation: glue-pulse 0.3s infinite;
        }
        
        .explosion {
            position: absolute;
            border-radius: 50%;
            background: radial-gradient(circle, #9ACD32, #32CD32, transparent);
            z-index: 14;
            pointer-events: none;
            animation: explode 0.3s forwards;
        }
        
        .health-bar {
            position: absolute;
            bottom: -5px;
            left: 5%;
            width: 90%;
            height: 3px;
            background: #333;
            z-index: 16;
        }
        
        .health-fill {
            height: 100%;
            background: #4CAF50;
            transition: width 0.3s;
        }
        
        .game-over {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            border-radius: 10px;
        }
        
        .hidden {
            display: none;
        }
        
        .wave-info {
            margin-top: 20px;
            text-align: center;
        }
        
        .instructions {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 0.9rem;
        }
        
        .placement-help {
            background: rgba(255, 215, 0, 0.2);
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            border-left: 3px solid gold;
        }
        
        .upgrade-section {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .upgrade-btn {
            background: linear-gradient(to bottom, #03befc, #0303fc) !important; 
            margin: 5px 0;
            padding: 8px 12px;
            font-size: 0.9rem;
        }
        
        .upgrade-btn:hover {
            background: linear-gradient(to bottom, #050e85, #0303fc) !important;
        }

        .wave-preview {
            margin-top: 10px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            text-align: center;
        }

        /* Animations */
        @keyframes pulse-slow {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        @keyframes bomb-spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes glue-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }
        
        @keyframes explode {
            0% { transform: scale(0); opacity: 1; }
            100% { transform: scale(3); opacity: 0; }
        }
        
        .tower-firing {
            animation: tower-fire 0.2s;
        }
        
        @keyframes tower-fire {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* Custom Scrollbars for Grid */
        .game-board::-webkit-scrollbar {
            width: 20px;
            height: 20px;
        }

        .game-board::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
        }

        .game-board::-webkit-scrollbar-thumb {
            background: #90EE90;
            border-radius: 10px;
            border: 3px solid rgba(0, 0, 0, 0.3);
        }

        .game-board::-webkit-scrollbar-thumb:hover {
            background: #76d976;
        }

        /* Firefox scrollbar */
        .game-board {
            scrollbar-width: thick;
            scrollbar-color: #90EE90 rgba(0, 0, 0, 0.3);
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            body {
                padding: 5px;
                overflow-y: auto;
            }
            
            header {
                margin-bottom: 10px;
                padding: 10px;
            }
            
            .game-stats {
                margin-bottom: 10px;
                padding: 8px 10px;
            }
            
            .game-area {
                flex-direction: column;
                gap: 10px;
            }
            
            .game-board {
                order: 1;
                width: 100%;
                padding: 10px;
                overflow: auto;
                -webkit-overflow-scrolling: touch;
                max-height: 60vh;
                display: flex;
                justify-content: center;
                align-items: flex-start;
            }
            
            .controls {
                order: 2;
                width: 100%;
            }
            
            #grid-container {
                width: 90%;
                height: auto;
                aspect-ratio: 1;
                max-width: 90vw;
                max-height: 90vw;
                margin: 0 auto;
            }
            
            .tower-selection {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Bug Defense</h1>
            <p>Defend against the bug invasion!</p>
            
            <!-- Audio Controls -->
            <div class="audio-controls">
                <button class="audio-btn" id="mute-btn">üîä</button>
                <button class="audio-btn" id="play-btn">‚ñ∂Ô∏è</button>
            </div>
        </header>
        
        <div class="game-stats">
            <div class="stat">
                <div>Level: <span id="level-display">1</span></div>
            </div>
            <div class="stat">
                <div>Lives: <span id="lives-display">15</span></div>
            </div>
            <div class="stat">
                <div>Money: $<span id="money-display">150</span></div>
            </div>
            <div class="stat">
                <div>Score: <span id="score-display">0</span></div>
            </div>
            <div class="stat">
                <div>Wave: <span id="wave-display">0/10</span></div>
            </div>
        </div>
        
        <div class="game-area">
            <div class="game-board">
                <div id="grid-container">
                    <!-- Game grid will be generated here -->
                </div>
            </div>
            
            <div class="controls">
                <h2>Shop</h2>
                <div class="tower-selection">
                    <div class="tower-option" data-type="weak">
                        <div class="tower-icon" id="weak-tower-icon"></div>
                        <div>Weak Spray</div>
                        <div>Cost: $50</div>
                        <div>Damage: 25</div>
                    </div>
                    <div class="tower-option" data-type="strong">
                        <div class="tower-icon" id="strong-tower-icon"></div>
                        <div>Strong Spray</div>
                        <div>Cost: $100</div>
                        <div>Damage: 50</div>
                    </div>
                    <div class="tower-option" data-type="bomb">
                        <div class="tower-icon" id="bomb-tower-icon"></div>
                        <div>Bug Bomb</div>
                        <div>Cost: $150</div>
                        <div>Damage: 100</div>
                    </div>
                    <div class="tower-option" data-type="glue">
                        <div class="tower-icon" id="glue-tower-icon"></div>
                        <div>Glue Trap</div>
                        <div>Cost: $150</div>
                        <div>Slows 80%</div>
                    </div>
                </div>
                
                <div class="placement-help" id="placement-help">
                    Select a tool above, then click on any <span style="color: lightgreen">green area</span> to place it. Avoid <span style="color: #8B4513">brown paths</span>.
                </div>

                <div class="upgrade-section">
                    <h3>Special Abilities</h3>
                    <button class="upgrade-btn" id="pest-control-btn">Call Pest Control! $500</button>
                </div>
                
                <div class="wave-info">
                    <button id="start-wave">Start Wave</button>
                    <div class="wave-preview" id="wave-preview">
                        Next wave: <span id="next-wave-type">Ants</span>
                    </div>
                    <div style="margin-top: 10px;">Enemies: <span id="enemies-remaining">0</span></div>
                </div>
                
                <div class="instructions">
                    <h3>Survive as many waves as you can.</h3>
                   
                </div>
            </div>
        </div>
        
        <div class="game-over hidden" id="game-over">
            <h2>Game Over</h2>
            <p>Your final score: <span id="final-score">0</span></p>
            <button id="restart-game">Play Again</button>
        </div>
    </div>

    <script>
      
        // Tower assets
        const ASSETS = {
            towers: {
                weak: "https://github.com/TitanBusinessPros/BugDefense-/raw/main/BugSpray.png",
                strong: "https://github.com/TitanBusinessPros/BugDefense-/raw/main/OrangeSpray.png",
                bomb: "https://github.com/TitanBusinessPros/BugDefense-/raw/main/BugBomb.png",
                glue: "https://github.com/TitanBusinessPros/BugDefense-/raw/main/GlueTrap1.png"
            },
            
            enemies: {
                drainfly: "https://github.com/TitanBusinessPros/BugDefense-/raw/main/DrainFly.png",
                slug: "https://github.com/TitanBusinessPros/BugDefense-/raw/main/Slug1.png",
                ant: "https://github.com/TitanBusinessPros/BugDefense-/raw/main/Ant1.png",
                spider: "https://github.com/TitanBusinessPros/BugDefense-/raw/main/Spider.png",
                millipede: "https://github.com/TitanBusinessPros/BugDefense-/raw/main/Milli1.png",
                cockroach: "https://github.com/TitanBusinessPros/BugDefense-/raw/main/Cockroach1.png",
                worm: "https://github.com/TitanBusinessPros/BugDefense-/raw/main/Worm1.png",
                tick: "https://github.com/TitanBusinessPros/BugDefense-/raw/main/TickCorrectly.png",
                mosquito: "https://github.com/TitanBusinessPros/BugDefense-/raw/main/Mosquito1.png",
                fly: "https://github.com/TitanBusinessPros/BugDefense-/raw/main/Fly1.png",
                termite: "https://github.com/TitanBusinessPros/BugDefense-/raw/main/TermiteCorrect.png",
                beetle: "https://github.com/TitanBusinessPros/BugDefense-/raw/main/Beetle.png",
                bugbug: "https://github.com/TitanBusinessPros/BugDefense-/raw/main/BugBug.png",
                snail: "https://github.com/TitanBusinessPros/BugDefense-/raw/main/Snail1.png",
                daddyspider: "https://github.com/TitanBusinessPros/BugDefense-/raw/main/LongLegsSpider.png",
                mouse: "https://github.com/TitanBusinessPros/BugDefense-/raw/main/Mouse1.png",
                rat: "https://github.com/TitanBusinessPros/BugDefense-/raw/main/Rat1.png"
            },
            pestControl: "https://github.com/TitanBusinessPros/BugDefense-/raw/main/PestControlVan.png",
            music: {
                main: "https://github.com/TitanBusinessPros/Gameville/raw/main/Gameville%20Dreams.mp3"
            }
        };
        
        // Game configuration
        const config = {
            gridSize: 12,
            cellSize: 70,
            initialMoney: 180,
            initialLives: 10,
            levels: [
                {
                    waves: 16,
                    path: [
                        {x: 0, y: 5}, {x: 3, y: 5}, {x: 3, y: 2}, 
                        {x: 7, y: 2}, {x: 7, y: 7}, {x: 11, y: 7}
                    ]
                }
            ],
            towerTypes: {
                weak: {
                    cost: 50,
                    damage: 25,
                    range: 110,
                    fireRate: 1,
                    color: '#4CAF50',
                    size: 80,
                    projectileType: 'bullet'
                },
                strong: {
                    cost: 100,
                    damage: 50,
                    range: 210,
                    fireRate: 0.5,
                    color: '#2196F3',
                    size: 100,
                    projectileType: 'strong'
                },
                bomb: {
                    cost: 150,
                    damage: 100,
                    range: 110,
                    fireRate: 0.2,
                    color: '#FF9800',
                    size: 80,
                    projectileType: 'bomb',
                    splashDamage: true,
                    splashRadius: 80
                },
                glue: {
                    cost: 150,
                    damage: 5,
                    range: 80,
                    fireRate: 0.7,
                    color: '#00BCD4',
                    size: 65,
                    slow: 0.15,
                    projectileType: 'glue'
                }
              },
                pestControlConfig: {
                    cost: 500,
                    speed: 0.05,
                    size: 125,
                    killRadius: 100,
                    damage: 9999
                },
            enemyTypes: [
                { name: 'Ant', baseHealth: 50, speed: 0.047, reward: 10, color: '#8B4513' },
                { name: 'Drain Fly', baseHealth: 75, speed: 0.05, reward: 10, color: '#696969' },
                { name: 'Mosquito', baseHealth: 120, speed: 0.055, reward: 10, color: '#696969' },
                { name: 'Fly', baseHealth: 170, speed: 0.052, reward: 15, color: '#696969' },
                { name: 'Tick', baseHealth: 210, speed: 0.05, reward: 15, color: '#8B0000' },
                { name: 'Slug', baseHealth: 300, speed: 0.042, reward: 15, color: '#228B22' },
                { name: 'Cockroach', baseHealth: 345, speed: 0.043, reward: 20, color: '#8B4513' },
                { name: 'Worm', baseHealth: 390, speed: 0.04, reward: 20, color: '#228B22' },
                { name: 'Snail', baseHealth: 400, speed: 0.036, reward: 20, color: '#228B22' },
                { name: 'Spider', baseHealth: 480, speed: 0.044, reward: 25, color: '#2F4F4F' },
                { name: 'Millipede', baseHealth: 520, speed: 0.035, reward: 25, color: '#8B4513' },
                { name: 'Long Legs', baseHealth: 620, speed: 0.042, reward: 25, color: '#9ACD32' },
                { name: 'Ladybug', baseHealth: 800, speed: 0.04, reward: 30, color: '#FF0000' },
                { name: 'Termite', baseHealth: 900, speed: 0.044, reward: 30, color: '#8B0000' },
                { name: 'Beetle', baseHealth: 1000, speed: 0.048, reward: 30, color: '#2F4F4F' },
                { name: 'Mice', baseHealth: 1000, speed: 0.05, reward: 50, color: '#808080' },
                { name: 'Rat', baseHealth: 1200, speed: 0.06, reward: 100, color: '#4B4B4B' }
            ]
        };

        // Game state
        let gameState = {
            currentLevel: 0,
            money: config.initialMoney,
            lives: config.initialLives,
            score: 0,
            selectedTower: null,
            towers: [],
            enemies: [],
            projectiles: [],
            pestControls: [],
            wave: 0,
            waveInProgress: false,
            enemiesSpawned: 0,
            enemiesKilled: 0,
            totalEnemies: 0,
            gameOver: false,
            hoverX: -1,
            hoverY: -1,
            upgrades: {
                damage: 1.0,
                fireRate: 1.0,
                range: 1.0
            }
        };

        // Audio state
        let audioState = {
            isMuted: false,
            isPlaying: false,
            audioElement: null
        };

        // Track last clicked cell for double-tap detection
        let lastClickState = {
            x: -1,
            y: -1,
            time: 0
        };
        
        // Detect if mobile
        let isMobileDevice = window.innerWidth <= 768;

        // Touch tracking for mobile
        let touchState = {
            lastTouchedCell: null,
            touchStartTime: 0,
            touchStartX: 0,
            touchStartY: 0
        };

        // DOM elements
        const gridContainer = document.getElementById('grid-container');
        const levelDisplay = document.getElementById('level-display');
        const livesDisplay = document.getElementById('lives-display');
        const moneyDisplay = document.getElementById('money-display');
        const scoreDisplay = document.getElementById('score-display');
        const waveDisplay = document.getElementById('wave-display');
        const enemiesRemainingDisplay = document.getElementById('enemies-remaining');
        const startWaveBtn = document.getElementById('start-wave');
        const gameOverScreen = document.getElementById('game-over');
        const finalScoreDisplay = document.getElementById('final-score');
        const restartBtn = document.getElementById('restart-game');
        const towerOptions = document.querySelectorAll('.tower-option');
        const placementHelp = document.getElementById('placement-help');
        const pestControlBtn = document.getElementById('pest-control-btn');
        const wavePreview = document.getElementById('wave-preview');
        const nextWaveType = document.getElementById('next-wave-type');
        const muteBtn = document.getElementById('mute-btn');
        const playBtn = document.getElementById('play-btn');

        function init() {
            loadAssets();
            createGrid();
            setupAudio();
            updateUI();
            setupEventListeners();
            loadLevel(0);
            
            audioState.audioElement.play().catch(() => {});
        }

        function loadAssets() {
            document.getElementById('weak-tower-icon').style.backgroundImage = `url(${ASSETS.towers.weak})`;
            document.getElementById('strong-tower-icon').style.backgroundImage = `url(${ASSETS.towers.strong})`;
            document.getElementById('bomb-tower-icon').style.backgroundImage = `url(${ASSETS.towers.bomb})`;
            document.getElementById('glue-tower-icon').style.backgroundImage = `url(${ASSETS.towers.glue})`;
        }

        function setupAudio() {
            audioState.audioElement = new Audio();
            audioState.audioElement.loop = true;
            audioState.audioElement.src = ASSETS.music.main;
        }

        function togglePlay() {
            if (!audioState.isMuted) {
                if (audioState.isPlaying) {
                    audioState.audioElement.pause();
                    audioState.isPlaying = false;
                    playBtn.textContent = '‚ñ∂Ô∏è';
                } else {
                    audioState.audioElement.play().catch(e => {
                        console.log("Audio play failed:", e);
                    });
                    audioState.isPlaying = true;
                    playBtn.textContent = '‚è∏Ô∏è';
                }
            }
        }

        function toggleMute() {
            audioState.isMuted = !audioState.isMuted;
            audioState.audioElement.muted = audioState.isMuted;
            
            if (audioState.isMuted) {
                muteBtn.textContent = 'üîá';
                if (audioState.isPlaying) {
                    audioState.audioElement.pause();
                }
            } else {
                muteBtn.textContent = 'üîä';
                if (audioState.isPlaying) {
                    audioState.audioElement.play().catch(e => {
                        console.log("Audio play failed:", e);
                    });
                }
            }
        }

        function createGrid() {
            gridContainer.innerHTML = '';
            gridContainer.style.width = `${config.gridSize * config.cellSize}px`;
            gridContainer.style.height = `${config.gridSize * config.cellSize}px`;
            
            for (let y = 0; y < config.gridSize; y++) {
                for (let x = 0; x < config.gridSize; x++) {
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell grass';
                    cell.style.width = `${config.cellSize}px`;
                    cell.style.height = `${config.cellSize}px`;
                    cell.style.left = `${x * config.cellSize}px`;
                    cell.style.top = `${y * config.cellSize}px`;
                    cell.dataset.x = x;
                    cell.dataset.y = y;
                    
                    // BOTH mobile and desktop get click
                    cell.addEventListener('click', (e) => {
                        console.log('CLICK on cell', x, y, 'tower selected:', gameState.selectedTower, 'isMobile:', isMobileDevice);
                        
                        if (isMobileDevice && gameState.selectedTower && !gameState.waveInProgress && !gameState.gameOver) {
                            // Mobile: first tap shows preview, second tap places
                            const now = Date.now();
                            const timeSinceLastClick = now - lastClickState.time;
                            const isSameCell = lastClickState.x === x && lastClickState.y === y;
                            
                            if (isSameCell && timeSinceLastClick < 2000) {
                                console.log('Mobile: Second tap - placing tower');
                                handleCellClick(x, y);
                                lastClickState = { x: -1, y: -1, time: 0 };
                            } else {
                                console.log('Mobile: First tap - showing preview');
                                handleCellHover(x, y);
                                lastClickState = { x, y, time: now };
                            }
                        } else {
                            // Desktop: normal click to place (preview shown by mouseenter)
                            handleCellClick(x, y);
                        }
                    });
                    
                    if (!isMobileDevice) {
                        // Desktop only: hover preview
                        cell.addEventListener('mouseenter', () => {
                            handleCellHover(x, y);
                        });
                    }
                    
                    gridContainer.appendChild(cell);
                }
            }
        }

        function loadLevel(levelIndex) {
            gameState.currentLevel = levelIndex;
            gameState.wave = 0;
            gameState.waveInProgress = false;
            gameState.enemiesSpawned = 0;
            gameState.enemiesKilled = 0;
            gameState.towers = [];
            gameState.enemies = [];
            gameState.projectiles = [];
            gameState.selectedTower = null;
            
            document.querySelectorAll('.tower, .enemy, .projectile, .tower-range, .explosion').forEach(el => {
                if (el.classList.contains('tower') && !el.classList.contains('range-display')) {
                    el.remove();
                }
            });
            
            document.querySelectorAll('.grid-cell').forEach(cell => {
                cell.className = 'grid-cell grass';
            });
            
            const level = config.levels[levelIndex];
            const path = level.path;
            
            for (let i = 0; i < path.length - 1; i++) {
                const start = path[i];
                const end = path[i + 1];
                
                if (start.y === end.y) {
                    const minX = Math.min(start.x, end.x);
                    const maxX = Math.max(start.x, end.x);
                    for (let x = minX; x <= maxX; x++) {
                        const cell = getCellAt(x, start.y);
                        if (cell) {
                            cell.className = 'grid-cell path';
                        }
                    }
                }
                else if (start.x === end.x) {
                    const minY = Math.min(start.y, end.y);
                    const maxY = Math.max(start.y, end.y);
                    for (let y = minY; y <= maxY; y++) {
                        const cell = getCellAt(start.x, y);
                        if (cell) {
                            cell.className = 'grid-cell path';
                        }
                    }
                }
            }
            
            clearRangeDisplay();
            updateUI();
        }

        function handleCellHover(x, y) {
            gameState.hoverX = x;
            gameState.hoverY = y;
            
            if (gameState.waveInProgress || gameState.gameOver || !gameState.selectedTower) {
                clearRangeDisplay();
                return;
            }
            
            const cell = getCellAt(x, y);
            if (!cell) return;
            
            // Clear all previous highlights
            document.querySelectorAll('.grid-cell.valid, .grid-cell.invalid').forEach(c => {
                c.classList.remove('valid', 'invalid');
            });
            
            const isPath = cell.classList.contains('path');
            const hasTower = gameState.towers.some(t => t.x === x && t.y === y);
            
            if (!isPath && !hasTower) {
                cell.classList.add('valid');
                showTowerRangePreview(x, y);
            } else {
                cell.classList.add('invalid');
                clearRangeDisplay();
            }
        }

        function showTowerRangePreview(x, y) {
            clearRangeDisplay();
            
            const towerType = config.towerTypes[gameState.selectedTower];
            const range = towerType.range * gameState.upgrades.range;
            
            const rangeDisplay = document.createElement('div');
            rangeDisplay.className = 'tower range-display';
            rangeDisplay.style.width = `${range * 2}px`;
            rangeDisplay.style.height = `${range * 2}px`;
            rangeDisplay.style.left = `${x * config.cellSize + config.cellSize/2 - range}px`;
            rangeDisplay.style.top = `${y * config.cellSize + config.cellSize/2 - range}px`;
            
            gridContainer.appendChild(rangeDisplay);
        }

        function clearRangeDisplay() {
            const existingPreview = document.querySelector('.tower.range-display');
            if (existingPreview) existingPreview.remove();
        }

        function handleCellClick(x, y) {
            if (gameState.waveInProgress || gameState.gameOver || !gameState.selectedTower) {
                return;
            }
            
            const cell = getCellAt(x, y);
            if (!cell) return;
            
            const isPath = cell.classList.contains('path');
            const hasTower = gameState.towers.some(t => t.x === x && t.y === y);
            
            if (isPath || hasTower) {
                return;
            }
            
            const towerType = config.towerTypes[gameState.selectedTower];
            if (gameState.money < towerType.cost) {
                return;
            }
            
            gameState.money -= towerType.cost;
            
            const tower = {
                type: gameState.selectedTower,
                x: x,
                y: y,
                damage: towerType.damage * gameState.upgrades.damage,
                range: towerType.range * gameState.upgrades.range,
                fireRate: towerType.fireRate * gameState.upgrades.fireRate,
                lastFired: 0,
                color: towerType.color,
                size: towerType.size,
                slow: towerType.slow,
                projectileType: towerType.projectileType,
                splashDamage: towerType.splashDamage,
                splashRadius: towerType.splashRadius
            };
            
            gameState.towers.push(tower);
            
            const towerElement = document.createElement('div');
            towerElement.className = 'tower';
            towerElement.style.width = `${tower.size}px`;
            towerElement.style.height = `${tower.size}px`;
            towerElement.style.left = `${x * config.cellSize + (config.cellSize - tower.size)/2}px`;
            towerElement.style.top = `${y * config.cellSize + (config.cellSize - tower.size)/2}px`;
            towerElement.style.backgroundImage = `url(${ASSETS.towers[tower.type]})`;
            towerElement.style.backgroundSize = 'contain';
            towerElement.style.backgroundRepeat = 'no-repeat';
            towerElement.style.backgroundPosition = 'center';
            gridContainer.appendChild(towerElement);
            
            document.querySelectorAll('.grid-cell.valid, .grid-cell.invalid').forEach(c => {
                c.classList.remove('valid', 'invalid');
            });
            
            clearRangeDisplay();
            
            // Deselect tower after placing so user can scroll freely
            gameState.selectedTower = null;
            
            updateUI();
        }

        function startWave() {
            if (gameState.waveInProgress || gameState.gameOver) return;
            
            gameState.wave++;
            gameState.waveInProgress = true;
            gameState.enemiesSpawned = 0;
            gameState.enemiesKilled = 0;
            if (gameState.wave <= 5) {
                gameState.totalEnemies = 15 + gameState.wave * 3;
            } else {
                gameState.totalEnemies = 5 + gameState.wave * 2;
            }
            
            document.querySelectorAll('.grid-cell.valid, .grid-cell.invalid').forEach(c => {
                c.classList.remove('valid', 'invalid');
            });
            clearRangeDisplay();
            
            if (gameState.wave === 16) {
                const mouseType = config.enemyTypes[15];
                const ratType = config.enemyTypes[16];
                const halfEnemies = Math.floor(gameState.totalEnemies / 2);
                
                for (let i = 0; i < halfEnemies; i++) {
                    setTimeout(() => {
                        if (!gameState.gameOver && gameState.waveInProgress) {
                            spawnEnemy(mouseType);
                        }
                    }, i * 1500);
                }
                
                for (let i = 0; i < gameState.totalEnemies - halfEnemies; i++) {
                    setTimeout(() => {
                        if (!gameState.gameOver && gameState.waveInProgress) {
                            spawnEnemy(ratType);
                        }
                    }, (halfEnemies + i) * 1500);
                }
            } else {
                const enemyTypeIndex = (gameState.wave - 1) % 15;
                const enemyType = config.enemyTypes[enemyTypeIndex];
                
                for (let i = 0; i < gameState.totalEnemies; i++) {
                    setTimeout(() => {
                        if (!gameState.gameOver && gameState.waveInProgress) {
                            spawnEnemy(enemyType);
                        }
                    }, i * 1500);
                }
            }
            
            updateUI();
        }

        function spawnEnemy(enemyType) {
            const level = config.levels[gameState.currentLevel];
            const path = level.path;
            
            const health = enemyType.baseHealth + (gameState.wave - 1) * 15;
            const speed = enemyType.speed;
            
            const enemy = {
                id: Date.now() + Math.random(),
                x: path[0].x,
                y: path[0].y,
                health: health,
                maxHealth: health,
                speed: speed,
                pathIndex: 0,
                reward: enemyType.reward + gameState.wave * 2,
                slow: 1,
                isSlowed: false,
                name: enemyType.name,
                color: enemyType.color
            };
            
            gameState.enemies.push(enemy);
            gameState.enemiesSpawned++;
            
            const enemyElement = document.createElement('div');
            enemyElement.className = 'enemy';
            enemyElement.id = `enemy-${enemy.id}`;
            enemyElement.style.width = '50px';
            enemyElement.style.height = '50px';
            enemyElement.style.left = `${enemy.x * config.cellSize + 10}px`;
            enemyElement.style.top = `${enemy.y * config.cellSize + 10}px`;
            
            let assetName = enemy.name.toLowerCase();
            if (enemy.name === 'Mice') assetName = 'mouse';
            if (enemy.name === 'Rat') assetName = 'rat';
            if (enemy.name === 'Long Legs') assetName = 'daddyspider';
            if (enemy.name === 'Ladybug') assetName = 'bugbug';
            if (enemy.name === 'Drain Fly') assetName = 'drainfly';
            
            enemyElement.style.backgroundImage = `url(${ASSETS.enemies[assetName]})`;
            enemyElement.style.backgroundSize = 'contain';
            enemyElement.style.backgroundRepeat = 'no-repeat';
            enemyElement.style.backgroundPosition = 'center';
            
            const healthBar = document.createElement('div');
            healthBar.className = 'health-bar';
            const healthFill = document.createElement('div');
            healthFill.className = 'health-fill';
            healthFill.style.width = '100%';
            healthBar.appendChild(healthFill);
            enemyElement.appendChild(healthBar);
            
            gridContainer.appendChild(enemyElement);
            
            updateUI();
        }

        function spawnPestControl() {
            if (gameState.money < config.pestControlConfig.cost) {
                return;
            }
            
            gameState.money -= config.pestControlConfig.cost;
            
            const level = config.levels[gameState.currentLevel];
            const path = level.path;
            
            const pestControl = {
                id: Date.now() + Math.random(),
                x: path[path.length - 1].x,
                y: path[path.length - 1].y,
                pathIndex: path.length - 1,
                speed: config.pestControlConfig.speed,
                damage: config.pestControlConfig.damage,
                killRadius: config.pestControlConfig.killRadius
            };
            
            gameState.pestControls.push(pestControl);
            
            const pestControlElement = document.createElement('div');
            pestControlElement.className = 'enemy';
            pestControlElement.id = `pestcontrol-${pestControl.id}`;
            pestControlElement.style.width = `${config.pestControlConfig.size}px`;
            pestControlElement.style.height = `${config.pestControlConfig.size}px`;
            pestControlElement.style.left = `${pestControl.x * config.cellSize + (config.cellSize - config.pestControlConfig.size)/2}px`;
            pestControlElement.style.top = `${pestControl.y * config.cellSize + (config.cellSize - config.pestControlConfig.size)/2}px`;
            pestControlElement.style.backgroundImage = `url(${ASSETS.pestControl})`;
            pestControlElement.style.backgroundSize = 'contain';
            pestControlElement.style.backgroundRepeat = 'no-repeat';
            pestControlElement.style.backgroundPosition = 'center';
            pestControlElement.style.zIndex = '20';
            pestControlElement.style.filter = 'drop-shadow(0 0 40px #b100cc)';
            
            gridContainer.appendChild(pestControlElement);
            
            updateUI();
        }

        function gameLoop() {
            if (gameState.gameOver) return;
            
            moveEnemies();
            movePestControls(); 
            fireTowers();
            moveProjectiles();
            checkWaveCompletion();
            
            updateUI();
            requestAnimationFrame(gameLoop);
        }

        function moveEnemies() {
            const level = config.levels[gameState.currentLevel];
            const path = level.path;
            
            gameState.enemies.forEach(enemy => {
                if (enemy.pathIndex >= path.length - 1) {
                    gameState.lives--;
                    removeEnemy(enemy.id);
                    if (gameState.lives <= 0) {
                        gameOver();
                    }
                    return;
                }
                
                const target = path[enemy.pathIndex + 1];
                const dx = target.x - enemy.x;
                const dy = target.y - enemy.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < 0.1) {
                    enemy.pathIndex++;
                } else {
                    const speed = enemy.speed * enemy.slow;
                    enemy.x += (dx / distance) * speed;
                    enemy.y += (dy / distance) * speed;
                }
                
                const enemyElement = document.getElementById(`enemy-${enemy.id}`);
                if (enemyElement) {
                    enemyElement.style.left = `${enemy.x * config.cellSize + 10}px`;
                    enemyElement.style.top = `${enemy.y * config.cellSize + 10}px`;
                    
                    if (enemy.slow < 1 && !enemy.isSlowed) {
                        enemyElement.classList.add('slowed');
                        enemy.isSlowed = true;
                    } else if (enemy.slow >= 1 && enemy.isSlowed) {
                        enemyElement.classList.remove('slowed');
                        enemy.isSlowed = false;
                    }
                }
            });
        }

        function movePestControls() {
            const level = config.levels[gameState.currentLevel];
            const path = level.path;
            
            gameState.pestControls.forEach(pestControl => {
                if (pestControl.pathIndex <= 0) {
                    removePestControl(pestControl.id);
                    return;
                }
                
                const target = path[pestControl.pathIndex - 1];
                const dx = target.x - pestControl.x;
                const dy = target.y - pestControl.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < 0.1) {
                    pestControl.pathIndex--;
                } else {
                    pestControl.x += (dx / distance) * pestControl.speed;
                    pestControl.y += (dy / distance) * pestControl.speed;
                }
                
                const pestControlElement = document.getElementById(`pestcontrol-${pestControl.id}`);
                if (pestControlElement) {
                    pestControlElement.style.left = `${pestControl.x * config.cellSize + (config.cellSize - config.pestControlConfig.size)/2}px`;
                    pestControlElement.style.top = `${pestControl.y * config.cellSize + (config.cellSize - config.pestControlConfig.size)/2}px`;
                }
                
                gameState.enemies.forEach(enemy => {
                    const enemyDx = (enemy.x - pestControl.x) * config.cellSize;
                    const enemyDy = (enemy.y - pestControl.y) * config.cellSize;
                    const enemyDistance = Math.sqrt(enemyDx * enemyDx + enemyDy * enemyDy);
                    
                    if (enemyDistance < pestControl.killRadius) {
                        enemy.health -= pestControl.damage;
                        updateEnemyHealthBar(enemy);
                        
                        if (enemy.health <= 0) {
                            gameState.money += enemy.reward;
                            gameState.score += enemy.reward;
                            removeEnemy(enemy.id);
                        }
                    }
                });
            });
        }

        function fireTowers() {
            const now = Date.now();
            
            gameState.towers.forEach(tower => {
                if (now - tower.lastFired < 1000 / tower.fireRate) return;
                
                let target = null;
                let minDistance = tower.range;
                
                gameState.enemies.forEach(enemy => {
                    const dx = (enemy.x + 0.5) - (tower.x + 0.5);
                    const dy = (enemy.y + 0.5) - (tower.y + 0.5);
                    const distance = Math.sqrt(dx * dx + dy * dy) * config.cellSize;
                    
                    if (distance < tower.range) {
                        if (!target || distance < minDistance) {
                            target = enemy;
                            minDistance = distance;
                        }
                    }
                });
                
                if (target) {
                    tower.lastFired = now;
                    
                    const towerElement = document.querySelector(`.tower[style*="left: ${tower.x * config.cellSize + (config.cellSize - tower.size)/2}px"][style*="top: ${tower.y * config.cellSize + (config.cellSize - tower.size)/2}px"]`);
                    if (towerElement) {
                        towerElement.classList.add('tower-firing');
                        setTimeout(() => towerElement.classList.remove('tower-firing'), 200);
                    }
                    
                    const projectile = {
                        id: Date.now() + Math.random(),
                        x: tower.x + 0.5,
                        y: tower.y + 0.5,
                        target: target.id,
                        damage: tower.damage,
                        color: tower.color,
                        slow: tower.slow,
                        type: tower.projectileType,
                        splashDamage: tower.splashDamage,
                        splashRadius: tower.splashRadius
                    };
                    
                    gameState.projectiles.push(projectile);
                    
                    const projectileElement = document.createElement('div');
                    projectileElement.className = `projectile ${projectile.type}`;
                    projectileElement.id = `projectile-${projectile.id}`;
                    projectileElement.style.left = `${tower.x * config.cellSize + config.cellSize/2 - 5}px`;
                    projectileElement.style.top = `${tower.y * config.cellSize + config.cellSize/2 - 5}px`;
                    gridContainer.appendChild(projectileElement);
                }
            });
        }

        function moveProjectiles() {
            gameState.projectiles.forEach((projectile, index) => {
                const targetEnemy = gameState.enemies.find(e => e.id === projectile.target);
                
                if (!targetEnemy) {
                    removeProjectile(projectile.id);
                    return;
                }
                
                const dx = (targetEnemy.x + 0.5) - projectile.x;
                const dy = (targetEnemy.y + 0.5) - projectile.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < 0.3) {
                    if (projectile.splashDamage) {
                        createExplosion(projectile.x, projectile.y, projectile.splashRadius);
                        
                        gameState.enemies.forEach(enemy => {
                            const enemyDx = enemy.x - (projectile.x - 0.5);
                            const enemyDy = enemy.y - (projectile.y - 0.5);
                            const enemyDistance = Math.sqrt(enemyDx * enemyDx + enemyDy * enemyDy) * config.cellSize;
                            
                            if (enemyDistance < projectile.splashRadius) {
                                enemy.health -= projectile.damage * 0.5;
                                updateEnemyHealthBar(enemy);
                                
                                if (enemy.health <= 0) {
                                    gameState.money += enemy.reward;
                                    gameState.score += enemy.reward;
                                    removeEnemy(enemy.id);
                                }
                            }
                        });
                    } else {
                        targetEnemy.health -= projectile.damage;
                        
                        if (projectile.slow) {
                            targetEnemy.slow = Math.min(targetEnemy.slow, projectile.slow);
                        }
                        
                        updateEnemyHealthBar(targetEnemy);
                        
                        if (targetEnemy.health <= 0) {
                            gameState.money += targetEnemy.reward;
                            gameState.score += targetEnemy.reward;
                            removeEnemy(targetEnemy.id);
                        }
                    }
                    
                    removeProjectile(projectile.id);
                } else {
                    const speed = projectile.type === 'strong' ? 0.3 : 0.2;
                    projectile.x += (dx / distance) * speed;
                    projectile.y += (dy / distance) * speed;
                    
                    const projectileElement = document.getElementById(`projectile-${projectile.id}`);
                    if (projectileElement) {
                        projectileElement.style.left = `${projectile.x * config.cellSize - 5}px`;
                        projectileElement.style.top = `${projectile.y * config.cellSize - 5}px`;
                    }
                }
            });
        }

        function createExplosion(x, y, radius) {
            const explosion = document.createElement('div');
            explosion.className = 'explosion';
            explosion.style.width = `${radius * 2}px`;
            explosion.style.height = `${radius * 2}px`;
            explosion.style.left = `${x * config.cellSize - radius}px`;
            explosion.style.top = `${y * config.cellSize - radius}px`;
            
            gridContainer.appendChild(explosion);
            
            setTimeout(() => {
                explosion.remove();
            }, 300);
        }

        function updateEnemyHealthBar(enemy) {
            const enemyElement = document.getElementById(`enemy-${enemy.id}`);
            if (enemyElement) {
                const healthFill = enemyElement.querySelector('.health-fill');
                if (healthFill) {
                    healthFill.style.width = `${(enemy.health / enemy.maxHealth) * 100}%`;
                }
            }
        }

        function checkWaveCompletion() {
            if (gameState.waveInProgress && 
                gameState.enemiesSpawned >= gameState.totalEnemies && 
                gameState.enemies.length === 0) {
                
                gameState.waveInProgress = false;
                
                if (gameState.wave === 16) {
                    showVictoryScreen();
                } else {
                    gameState.money += 60;
                    gameState.score += 150;
                }
                
                updateUI();
            }
        }

        function removeEnemy(id) {
            gameState.enemies = gameState.enemies.filter(e => e.id !== id);
            gameState.enemiesKilled++;
            
            const enemyElement = document.getElementById(`enemy-${id}`);
            if (enemyElement) {
                enemyElement.remove();
            }
        }

        function removeProjectile(id) {
            gameState.projectiles = gameState.projectiles.filter(p => p.id !== id);
            
            const projectileElement = document.getElementById(`projectile-${id}`);
            if (projectileElement) {
                projectileElement.remove();
            }
        }
        
        function removePestControl(id) {
            gameState.pestControls = gameState.pestControls.filter(pc => pc.id !== id);
            
            const pestControlElement = document.getElementById(`pestcontrol-${id}`);
            if (pestControlElement) {
                pestControlElement.remove();
            }
        }

        function getCellAt(x, y) {
            return document.querySelector(`[data-x="${x}"][data-y="${y}"]`);
        }

        function updateUI() {
            levelDisplay.textContent = gameState.currentLevel + 1;
            livesDisplay.textContent = gameState.lives;
            moneyDisplay.textContent = gameState.money;
            scoreDisplay.textContent = gameState.score;
            
            const level = config.levels[gameState.currentLevel];
            waveDisplay.textContent = `${gameState.wave}/${level.waves}`;
            enemiesRemainingDisplay.textContent = gameState.totalEnemies - gameState.enemiesKilled;
            
            if (!gameState.waveInProgress && gameState.wave < level.waves) {
                if (gameState.wave === 15) {
                    nextWaveType.textContent = `BOSS: Mice & Rats`;
                } else {
                    const nextWaveTypeIndex = gameState.wave % 15;
                    const nextEnemyType = config.enemyTypes[nextWaveTypeIndex];
                    nextWaveType.textContent = `${nextEnemyType.name}s`;
                }
                wavePreview.style.display = 'block';
            } else {
                wavePreview.style.display = 'none';
            }
            
            towerOptions.forEach(option => {
                const type = option.dataset.type;
                const cost = config.towerTypes[type].cost;
                const isSelected = gameState.selectedTower === type;
                const canAfford = gameState.money >= cost;
                
                option.classList.toggle('selected', isSelected);
                option.style.opacity = canAfford ? '1' : '0.5';
            });
            
            pestControlBtn.disabled = gameState.money < config.pestControlConfig.cost;
            
            if (gameState.selectedTower) {
                const towerType = config.towerTypes[gameState.selectedTower];
                placementHelp.innerHTML = `<strong>${gameState.selectedTower.charAt(0).toUpperCase() + gameState.selectedTower.slice(1)} Tool</strong> selected! Click on any <span style="color: lightgreen">green area</span> to place ($${towerType.cost}).`;
            } else {
                placementHelp.innerHTML = `Select a tool above, then click on any <span style="color: lightgreen">green area</span> to place it. Avoid <span style="color: #8B4513">brown paths</span>.`;
            }
            
            startWaveBtn.disabled = gameState.waveInProgress || gameState.gameOver;
            startWaveBtn.textContent = gameState.waveInProgress ? 'Wave In Progress...' : 'Start Wave';
        }

        function gameOver() {
            gameState.gameOver = true;
            gameOverScreen.classList.remove('hidden');
            gameOverScreen.querySelector('h2').textContent = 'Game Over';
            gameOverScreen.querySelector('p').innerHTML = `Your final score: <span id="final-score">${gameState.score}</span>`;
            finalScoreDisplay.textContent = gameState.score;
        }

        function showVictoryScreen() {
            gameState.gameOver = true;
            const victoryScreen = gameOverScreen;
            victoryScreen.querySelector('h2').textContent = 'üéâ VICTORY! üéâ';
            victoryScreen.querySelector('p').innerHTML = `You defeated all the bugs!<br>Your final score: <span id="final-score">${gameState.score}</span>`;
            victoryScreen.classList.remove('hidden');
        }

        function setupEventListeners() {
            towerOptions.forEach(option => {
                option.addEventListener('click', () => {
                    const type = option.dataset.type;
                    const cost = config.towerTypes[type].cost;
                    
                    if (gameState.money >= cost) {
                        gameState.selectedTower = type;
                        updateUI();
                        
                        if (gameState.hoverX !== -1 && gameState.hoverY !== -1) {
                            handleCellHover(gameState.hoverX, gameState.hoverY);
                        }
                    }
                });
            });
            
            pestControlBtn.addEventListener('click', () => {
                spawnPestControl();
            });
            
            startWaveBtn.addEventListener('click', startWave);
            muteBtn.addEventListener('click', toggleMute);
            playBtn.addEventListener('click', togglePlay);
            
            restartBtn.addEventListener('click', () => {
                gameState = {
                    currentLevel: 0,
                    money: config.initialMoney,
                    lives: config.initialLives,
                    score: 0,
                    selectedTower: null,
                    towers: [],
                    enemies: [],
                    projectiles: [],
                    pestControls: [],
                    wave: 0,
                    waveInProgress: false,
                    enemiesSpawned: 0,
                    enemiesKilled: 0,
                    totalEnemies: 0,
                    gameOver: false,
                    hoverX: -1,
                    hoverY: -1,
                    upgrades: {
                        damage: 1.0,
                        fireRate: 1.0,
                        range: 1.0
                    }
                };
                
                gameOverScreen.classList.add('hidden');
                loadLevel(0);
                gameLoop();
            });
        }

        init();
        gameLoop();
    </script>
</body>
</html>
